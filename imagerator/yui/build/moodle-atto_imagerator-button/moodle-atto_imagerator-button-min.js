YUI.add("moodle-atto_imagerator-button",function(c,e){c.namespace("M.atto_imagerator").Button=c.Base.create("button",c.M.editor_atto.EditorPlugin,[],{initializer:function(){this.addButton({icon:"e/insert_edit_image",title:"imagerator",callback:this._generateImage})},_generateImage:function(){var e=this._getSelectedText();if(e)if(e.length<15)alert("Описание слишком короткое. Пожалуйста, введите описание не короче 15 символов (чем больше, тем лучше, но не более 100 символов)");else if(300<e.length)alert("Описание слишком длинное. Пожалуйста, введите описание не длиннее 300 символов");else{var t=this.get("server_url"),i=new Headers({"User-Agent":"atto_imagerator/0.0.1"});const o={prompt:e,width:this.get("width"),height:this.get("height"),steps:this.get("steps")},r=new URL(t);Object.keys(o).forEach(e=>r.searchParams.append(e,o[e])),fetch(r,{headers:i}).then(e=>{if(e.ok)return e.blob();throw new Error("Network response was not ok")}).then(e=>{e=new File([e],"file_name.png");this._uploadImage(e)})["catch"](e=>{console.error("Fetch Error:",e)})}else alert("Текст не выделен. Сначала выделите текст, на основании которого будет сгенерирована иллюстрация.")},_getSelectedText:function(){return window.getSelection?window.getSelection().toString():document.selection.createRange?document.selection.createRange().text:void 0},_uploadImage:function(e){var t,i,o,r,a,n,s,d=this,l=this.get("host"),p=c.Handlebars.compile('<img src="{{url}}" alt="{{alt}}" {{#if width}}width="{{width}}" {{/if}}{{#if height}}height="{{height}}" {{/if}}{{#if presentation}}role="presentation" {{/if}}{{#if customstyle}}style="{{customstyle}}" {{/if}}{{#if classlist}}class="{{classlist}}" {{/if}}{{#if id}}id="{{id}}" {{/if}}/>');for(l.saveSelection(),require(["core_form/events"],function(e){e.notifyUploadStarted(d.editor.get("id"))}),a=(t=l.get("filepickeroptions").image).savepath===undefined?"/":t.savepath,i=new FormData,r=new XMLHttpRequest,n=Object.keys(t.repositories),i.append("repo_upload_file",e),i.append("itemid",t.itemid),s=0;s<n.length;s++)if("upload"===t.repositories[n[s]].type){i.append("repo_id",t.repositories[n[s]].id);break}i.append("env",t.env),i.append("sesskey",M.cfg.sesskey),i.append("client_id",t.client_id),i.append("savepath",a),i.append("ctx_id",t.context.id),e=(new Date).getTime(),o="moodleimage_"+Math.round(1e5*Math.random())+"-"+e,l.focus(),l.restoreSelection(),a=p({url:M.util.image_url("i/loading_small","moodle"),alt:M.util.get_string("uploading","atto_imagerator"),id:o}),l.insertContentAtFocusPoint(a),d.markUpdated(),r.onreadystatechange=function(){var e,t,i=d.editor.one("#"+o);if(4===r.readyState){if(200===r.status){if(e=JSON.parse(r.responseText)){if(e.error)throw i&&i.remove(!0),require(["core_form/events"],function(e){e.notifyUploadCompleted(d.editor.get("id"))}),new M.core.ajaxException(e);(t=e).event&&"fileexists"===e.event&&(t=e.newfile),e=p({url:t.url,presentation:!0,classlist:CSS.RESPONSIVE}),t=c.Node.create(e),i?i.replace(t):d.editor.appendChild(t),d.markUpdated()}}else c.use("moodle-core-notification-alert",function(){require(["core_form/events"],function(e){e.notifyUploadCompleted(d.editor.get("id"))}),new M.core.alert({message:M.util.get_string("servererror","moodle")})}),i&&i.remove(!0);require(["core_form/events"],function(e){e.notifyUploadCompleted(d.editor.get("id"))})}},r.open("POST",M.cfg.wwwroot+"/repository/repository_ajax.php?action=upload",!0),r.send(i)}},{ATTRS:{server_url:{value:0},width:{value:0},height:{value:0},steps:{value:0}}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});