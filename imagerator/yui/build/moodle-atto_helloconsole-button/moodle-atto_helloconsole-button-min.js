YUI.add("moodle-atto_helloconsole-button",function(p,e){p.namespace("M.atto_helloconsole").Button=p.Base.create("button",p.M.editor_atto.EditorPlugin,[],{initializer:function(){console.log("Привет"),this.addButton({icon:"e/insert_edit_image",title:"helloconsole",callback:this._generateImage})},_generateImage:function(){var e=this._getSelectedText();if(e)if(e.length<15)alert("Описание слишком короткое. Пожалуйста, введите описание не короче 15 символов (чем больше, тем лучше, но не более 100 символов)");else if(100<e.length)alert("Описание слишком длинное. Пожалуйста, введите описание не длинее 100 символов");else{var t=this.get("server_url"),o=new Headers({"User-Agent":"MoodlePluginAPI"});const i={prompt:e,width:this.get("width"),height:this.get("height"),steps:this.get("steps")},n=new URL(t);Object.keys(i).forEach(e=>n.searchParams.append(e,i[e])),fetch(n,{headers:o}).then(e=>{if(e.ok)return console.log(e),e.blob();throw new Error("Network response was not ok")}).then(e=>{e=new File([e],"file_name.png");this._uploadImage(e)})["catch"](e=>{console.error("Fetch Error:",e)}),console.log(i,n)}else alert("Текст не выбран.")},_getSelectedText:function(){return window.getSelection?window.getSelection().toString():document.selection.createRange?document.selection.createRange().text:void 0},_uploadImage:function(e){var t,o,i,n,r,a,s,l=this,d=this.get("host"),c=p.Handlebars.compile('<img src="{{url}}" alt="{{alt}}" {{#if width}}width="{{width}}" {{/if}}{{#if height}}height="{{height}}" {{/if}}{{#if presentation}}role="presentation" {{/if}}{{#if customstyle}}style="{{customstyle}}" {{/if}}{{#if classlist}}class="{{classlist}}" {{/if}}{{#if id}}id="{{id}}" {{/if}}/>');for(d.saveSelection(),require(["core_form/events"],function(e){e.notifyUploadStarted(l.editor.get("id"))}),r=(t=d.get("filepickeroptions").image).savepath===undefined?"/":t.savepath,o=new FormData,n=new XMLHttpRequest,a=Object.keys(t.repositories),o.append("repo_upload_file",e),o.append("itemid",t.itemid),s=0;s<a.length;s++)if("upload"===t.repositories[a[s]].type){o.append("repo_id",t.repositories[a[s]].id);break}o.append("env",t.env),o.append("sesskey",M.cfg.sesskey),o.append("client_id",t.client_id),o.append("savepath",r),o.append("ctx_id",t.context.id),e=(new Date).getTime(),i="moodleimage_"+Math.round(1e5*Math.random())+"-"+e,d.focus(),d.restoreSelection(),r=c({url:M.util.image_url("i/loading_small","moodle"),alt:M.util.get_string("uploading","atto_helloconsole"),id:i}),d.insertContentAtFocusPoint(r),l.markUpdated(),n.onreadystatechange=function(){var e,t,o=l.editor.one("#"+i);if(4===n.readyState){if(200===n.status){if(e=JSON.parse(n.responseText)){if(e.error)throw o&&o.remove(!0),require(["core_form/events"],function(e){e.notifyUploadCompleted(l.editor.get("id"))}),new M.core.ajaxException(e);(t=e).event&&"fileexists"===e.event&&(t=e.newfile),e=c({url:t.url,presentation:!0,classlist:CSS.RESPONSIVE}),t=p.Node.create(e),o?o.replace(t):l.editor.appendChild(t),l.markUpdated()}}else p.use("moodle-core-notification-alert",function(){require(["core_form/events"],function(e){e.notifyUploadCompleted(l.editor.get("id"))}),new M.core.alert({message:M.util.get_string("servererror","moodle")})}),o&&o.remove(!0);require(["core_form/events"],function(e){e.notifyUploadCompleted(l.editor.get("id"))})}},n.open("POST",M.cfg.wwwroot+"/repository/repository_ajax.php?action=upload",!0),n.send(o)}},{ATTRS:{server_url:{value:0},width:{value:0},height:{value:0},steps:{value:0}}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});